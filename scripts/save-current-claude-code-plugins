#!/usr/bin/env bash

# Script to save current Claude Code plugins from global config to local repository

# Colors for omarchy theme
RED='\033[38;5;1m'
GREEN='\033[38;5;2m'
YELLOW='\033[38;5;3m'
BLUE='\033[38;5;4m'
CYAN='\033[38;5;6m'
NC='\033[0m'

TOOLS_DIR="/home/arc/tools"
CLAUDE_GLOBAL_PLUGINS="$HOME/.claude/plugins"
CLAUDE_LOCAL_PLUGINS="$TOOLS_DIR/assistants/claude/plugins"

show_help() {
    echo -e "${CYAN}Usage:${NC} $0 [OPTIONS]"
    echo
    echo -e "${YELLOW}Description:${NC}"
    echo "  Saves current Claude Code plugins from ~/.claude/plugins to assistants/claude/plugins"
    echo "  This allows you to version control your plugin configuration."
    echo
    echo -e "${YELLOW}Options:${NC}"
    echo "  -n, --dry-run      Show what would be copied without making changes"
    echo "  -h, --help         Show this help"
    echo
    echo -e "${YELLOW}Source:${NC} $CLAUDE_GLOBAL_PLUGINS"
    echo -e "${YELLOW}Destination:${NC} $CLAUDE_LOCAL_PLUGINS"
}

# Parse arguments
DRY_RUN=false
while [[ $# -gt 0 ]]; do
    case $1 in
        -n|--dry-run)
            DRY_RUN=true
            shift
            ;;
        -h|--help)
            show_help
            exit 0
            ;;
        *)
            echo -e "${RED}Error:${NC} Unknown option: $1"
            show_help
            exit 1
            ;;
    esac
done

echo -e "${CYAN}Save Current Claude Code Plugins${NC}"
echo "=================================="
echo

# Check if source directory exists
if [ ! -d "$CLAUDE_GLOBAL_PLUGINS" ]; then
    echo -e "${RED}Error:${NC} Source directory not found: $CLAUDE_GLOBAL_PLUGINS"
    echo "Make sure Claude Code is installed and has plugins configured."
    exit 1
fi

echo -e "${BLUE}Source:${NC} $CLAUDE_GLOBAL_PLUGINS"
echo -e "${BLUE}Destination:${NC} $CLAUDE_LOCAL_PLUGINS"
echo

if [ "$DRY_RUN" = true ]; then
    echo -e "${YELLOW}[DRY RUN]${NC} Would copy the following:"
    echo
    rsync -av --dry-run "$CLAUDE_GLOBAL_PLUGINS/" "$CLAUDE_LOCAL_PLUGINS/"
    echo
    echo -e "${YELLOW}[DRY RUN]${NC} No changes made. Run without -n to apply."
else
    # Create destination directory if it doesn't exist
    mkdir -p "$CLAUDE_LOCAL_PLUGINS"

    # Copy plugins directory
    echo -e "${BLUE}Saving plugins...${NC}"
    rsync -av "$CLAUDE_GLOBAL_PLUGINS/" "$CLAUDE_LOCAL_PLUGINS/"

    if [ $? -eq 0 ]; then
        echo
        echo -e "${GREEN}✓${NC} Successfully saved Claude Code plugins"
        echo -e "${CYAN}Tip:${NC} Commit these changes to version control with: git add assistants/claude/plugins && git commit"
    else
        echo
        echo -e "${RED}✗${NC} Failed to save plugins"
        exit 1
    fi
fi
