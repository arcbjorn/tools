#!/bin/bash

# Script to configure global assistant settings
set -e

INTERACTIVE=true

# Parse command line arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --non-interactive)
            INTERACTIVE=false
            shift
            ;;
        --help|-h)
            echo "Usage: $0 [OPTIONS]"
            echo "Options:"
            echo "  --non-interactive   Run without prompts"
            echo "  --help, -h          Show this help message"
            echo ""
            echo "This script configures global assistant settings:"
            echo "  - Merges settings into ~/.claude/settings.json"
            echo "  - Merges settings into ~/.codex/config.toml"
            echo "  - Merges settings into ~/.gemini/settings.json"
            echo "  - Creates/updates ~/.claude/CLAUDE.md with tool preferences"
            echo "  - Creates/updates ~/.codex/AGENTS.md with tool preferences"
            echo "  - Creates/updates ~/.gemini/GEMINI.md with tool preferences"
            echo "  - Copies commands to ~/.claude/commands/"
            echo "  - Copies prompts to ~/.codex/prompts/"
            echo "  - Copies commands to ~/.gemini/commands/"
            echo ""
            echo "Documentation for global settings:"
            echo "  Claude:  https://docs.anthropic.com/en/docs/claude-code/settings"
            echo "  Codex:   https://github.com/openai/codex/blob/main/docs/config.md"
            echo "  Gemini:  https://github.com/google-gemini/gemini-cli/blob/main/docs/cli/configuration.md"
            echo ""
            echo "Documentation for global memory files:"
            echo "  Claude:  https://docs.anthropic.com/en/docs/claude-code/memory#determine-memory-type"
            echo "  Codex:   https://github.com/openai/codex/blob/main/docs/getting-started.md#memory-with-agentsmd"
            echo "  Gemini:  https://github.com/google-gemini/gemini-cli/blob/main/docs/cli/configuration.md#example-context-file-content-eg-geminimd"
            echo ""
            echo "Documentation for commands/prompts:"
            echo "  Claude:  https://docs.anthropic.com/en/docs/claude-code/common-workflows#create-personal-slash-commands"
            echo "  Codex:   https://github.com/openai/codex/blob/main/docs/prompts.md"
            echo "  Gemini:  https://github.com/google-gemini/gemini-cli/blob/main/docs/cli/commands.md#example-a-pure-function-refactoring-command"
            exit 0
            ;;
        *)
            echo "Unknown option: $1"
            echo "Use --help for usage information"
            exit 1
            ;;
    esac
done

echo "Configure Global Assistant Settings"
echo "===================================="

# Check required commands
echo "Checking required commands..."
MISSING_COMMANDS=()

if ! command -v claude >/dev/null 2>&1; then
    MISSING_COMMANDS+=("claude")
fi

if ! command -v codex >/dev/null 2>&1; then
    MISSING_COMMANDS+=("codex")
fi

if ! command -v gemini >/dev/null 2>&1; then
    MISSING_COMMANDS+=("gemini")
fi

if ! command -v opencode >/dev/null 2>&1; then
    MISSING_COMMANDS+=("opencode")
fi

if ! command -v ast-grep >/dev/null 2>&1; then
    MISSING_COMMANDS+=("ast-grep")
fi

if [ ${#MISSING_COMMANDS[@]} -ne 0 ]; then
    echo "Error: Missing required commands: ${MISSING_COMMANDS[*]}"
    echo "Please install them before running this script"
    exit 1
fi

# Determine config directories
CLAUDE_CONFIG_DIR="$HOME/.claude"
CLAUDE_CONFIG_FILE="$CLAUDE_CONFIG_DIR/settings.json"
CODEX_CONFIG_DIR="$HOME/.codex"
GEMINI_CONFIG_DIR="$HOME/.gemini"
OPENCODE_CONFIG_DIR="$HOME/.opencode"

# Create config directory if it doesn't exist
if [ ! -d "$CLAUDE_CONFIG_DIR" ]; then
    echo "Creating Claude config directory: $CLAUDE_CONFIG_DIR"
    mkdir -p "$CLAUDE_CONFIG_DIR"
fi

# Check if config file exists and read current settings
if [ -f "$CLAUDE_CONFIG_FILE" ]; then
    echo "Found existing config file: $CLAUDE_CONFIG_FILE"
    
    # Check if includeCoAuthoredBy is already set to false
    if command -v jq >/dev/null 2>&1; then
        CURRENT_VALUE=$(jq -r '.includeCoAuthoredBy // empty' "$CLAUDE_CONFIG_FILE" 2>/dev/null || echo "")
        if [ "$CURRENT_VALUE" = "false" ]; then
            echo "includeCoAuthoredBy is already set to false"
            if [ "$INTERACTIVE" = true ]; then
                read -p "Continue anyway? (y/N): " confirm
                if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
                    echo "Aborted."
                    exit 0
                fi
            else
                echo "No changes needed."
                exit 0
            fi
        fi
    fi
else
    echo "Creating new config file: $CLAUDE_CONFIG_FILE"
fi

# Confirm before proceeding (interactive mode only)
if [ "$INTERACTIVE" = true ]; then
    echo ""
    echo "This will:"
    echo "  1. Merge settings into ~/.claude/settings.json"
    echo "  2. Merge settings into ~/.codex/config.toml"
    echo "  3. Merge settings into ~/.gemini/settings.json"
    echo "  4. Merge settings into ~/.opencode/settings.json"
    echo "  5. Create/update ~/.claude/CLAUDE.md with tool preferences"
    echo "  6. Create/update ~/.codex/AGENTS.md with tool preferences"
    echo "  7. Create/update ~/.gemini/GEMINI.md with tool preferences"
    echo "  8. Create/update ~/.opencode/OPENCODE.md with tool preferences"
    echo "  9. Copy commands to respective directories"
    echo ""
    read -p "Proceed? (Y/n): " confirm
    
    if [[ "$confirm" =~ ^[Nn]$ ]]; then
        echo "Aborted."
        exit 1
    fi
fi

echo ""
echo "Configuring global assistant settings..."

# Directories should already exist - just verify
if [ ! -d "$CLAUDE_CONFIG_DIR" ]; then
    echo "Error: $CLAUDE_CONFIG_DIR directory not found. Please ensure claude is properly installed."
    exit 1
fi

if [ ! -d "$CODEX_CONFIG_DIR" ]; then
    echo "Error: $CODEX_CONFIG_DIR directory not found. Please ensure codex is properly installed."
    exit 1
fi

if [ ! -d "$GEMINI_CONFIG_DIR" ]; then
    echo "Error: $GEMINI_CONFIG_DIR directory not found. Please ensure gemini is properly installed."
    exit 1
fi

if [ ! -d "$OPENCODE_CONFIG_DIR" ]; then
    echo "Error: $OPENCODE_CONFIG_DIR directory not found. Please ensure opencode is properly installed."
    exit 1
fi

# Create/update global CLAUDE.md
CLAUDE_MD_PATH="$HOME/.claude/CLAUDE.md"
ASSISTANTS_DIR="/home/arc/tools/assistants"
echo "Creating/updating global CLAUDE.md..."

cat "$ASSISTANTS_DIR/common/global_instructions.md" > "$CLAUDE_MD_PATH"
if [ -s "$ASSISTANTS_DIR/claude/global_instructions.md" ]; then
    echo "" >> "$CLAUDE_MD_PATH"
    cat "$ASSISTANTS_DIR/claude/global_instructions.md" >> "$CLAUDE_MD_PATH"
fi

# Copy common commands to Claude commands directory
CLAUDE_COMMANDS_DIR="$HOME/.claude/commands"
mkdir -p "$CLAUDE_COMMANDS_DIR"
# Ensure source directories exist in tools
mkdir -p "$ASSISTANTS_DIR/common/commands"
mkdir -p "$ASSISTANTS_DIR/claude/commands"
if [ -d "$ASSISTANTS_DIR/common/commands" ]; then
    cp -r "$ASSISTANTS_DIR/common/commands"/* "$CLAUDE_COMMANDS_DIR/" 2>/dev/null || true
fi
if [ -d "$ASSISTANTS_DIR/claude/commands" ]; then
    cp -r "$ASSISTANTS_DIR/claude/commands"/* "$CLAUDE_COMMANDS_DIR/" 2>/dev/null || true
fi

# Create/update global AGENTS.md for Codex
CODEX_MD_PATH="$HOME/.codex/AGENTS.md"
echo "Creating/updating global AGENTS.md..."

cat "$ASSISTANTS_DIR/common/global_instructions.md" > "$CODEX_MD_PATH"
if [ -s "$ASSISTANTS_DIR/codex/global_instructions.md" ]; then
    echo "" >> "$CODEX_MD_PATH"
    cat "$ASSISTANTS_DIR/codex/global_instructions.md" >> "$CODEX_MD_PATH"
fi

# Copy common commands to Codex prompts directory
CODEX_PROMPTS_DIR="$HOME/.codex/prompts"
mkdir -p "$CODEX_PROMPTS_DIR"
# Ensure source directories exist in tools
mkdir -p "$ASSISTANTS_DIR/common/commands"
mkdir -p "$ASSISTANTS_DIR/codex/prompts"
if [ -d "$ASSISTANTS_DIR/common/commands" ]; then
    cp -r "$ASSISTANTS_DIR/common/commands"/* "$CODEX_PROMPTS_DIR/" 2>/dev/null || true
fi
if [ -d "$ASSISTANTS_DIR/codex/prompts" ]; then
    cp -r "$ASSISTANTS_DIR/codex/prompts"/* "$CODEX_PROMPTS_DIR/" 2>/dev/null || true
fi

# Create/update global GEMINI.md for Gemini
GEMINI_MD_PATH="$HOME/.gemini/GEMINI.md"
echo "Creating/updating global GEMINI.md..."

cat "$ASSISTANTS_DIR/common/global_instructions.md" > "$GEMINI_MD_PATH"
if [ -s "$ASSISTANTS_DIR/gemini/global_instructions.md" ]; then
    echo "" >> "$GEMINI_MD_PATH"
    cat "$ASSISTANTS_DIR/gemini/global_instructions.md" >> "$GEMINI_MD_PATH"
fi

# Copy common commands to Gemini commands directory
GEMINI_COMMANDS_DIR="$HOME/.gemini/commands"
mkdir -p "$GEMINI_COMMANDS_DIR"
# Ensure source directories exist in tools
mkdir -p "$ASSISTANTS_DIR/common/commands"
mkdir -p "$ASSISTANTS_DIR/gemini/commands"
if [ -d "$ASSISTANTS_DIR/common/commands" ]; then
    cp -r "$ASSISTANTS_DIR/common/commands"/* "$GEMINI_COMMANDS_DIR/" 2>/dev/null || true
fi
if [ -d "$ASSISTANTS_DIR/gemini/commands" ]; then
    cp -r "$ASSISTANTS_DIR/gemini/commands"/* "$GEMINI_COMMANDS_DIR/" 2>/dev/null || true
fi

# Create/update global OPENCODE.md for OpenCode
OPENCODE_MD_PATH="$HOME/.opencode/OPENCODE.md"
echo "Creating/updating global OPENCODE.md..."

cat "$ASSISTANTS_DIR/common/global_instructions.md" > "$OPENCODE_MD_PATH"
if [ -s "$ASSISTANTS_DIR/opencode/global_instructions.md" ]; then
    echo "" >> "$OPENCODE_MD_PATH"
    cat "$ASSISTANTS_DIR/opencode/global_instructions.md" >> "$OPENCODE_MD_PATH"
fi

# Copy common commands to OpenCode commands directory
OPENCODE_COMMANDS_DIR="$HOME/.opencode/commands"
mkdir -p "$OPENCODE_COMMANDS_DIR"
# Ensure source directories exist in tools
mkdir -p "$ASSISTANTS_DIR/common/commands"
mkdir -p "$ASSISTANTS_DIR/opencode/commands"
if [ -d "$ASSISTANTS_DIR/common/commands" ]; then
    cp -r "$ASSISTANTS_DIR/common/commands"/* "$OPENCODE_COMMANDS_DIR/" 2>/dev/null || true
fi
if [ -d "$ASSISTANTS_DIR/opencode/commands" ]; then
    cp -r "$ASSISTANTS_DIR/opencode/commands"/* "$OPENCODE_COMMANDS_DIR/" 2>/dev/null || true
fi

# Create or update Claude config file
if command -v jq >/dev/null 2>&1; then
    # Use jq for proper JSON merging
    if [ -f "$CLAUDE_CONFIG_FILE" ]; then
        # Merge with existing file
        jq -s '.[0] * .[1]' "$CLAUDE_CONFIG_FILE" "$ASSISTANTS_DIR/claude/settings.json" > "${CLAUDE_CONFIG_FILE}.tmp" && \
        mv "${CLAUDE_CONFIG_FILE}.tmp" "$CLAUDE_CONFIG_FILE"
    else
        # Create new file from template
        cp "$ASSISTANTS_DIR/claude/settings.json" "$CLAUDE_CONFIG_FILE"
    fi
else
    # Fallback: create simple JSON without jq
    if [ -f "$CLAUDE_CONFIG_FILE" ]; then
        echo "Warning: jq not found. Creating backup and overwriting config file."
        cp "$CLAUDE_CONFIG_FILE" "${CLAUDE_CONFIG_FILE}.backup"
    fi
    cp "$ASSISTANTS_DIR/claude/settings.json" "$CLAUDE_CONFIG_FILE"
fi

# Create or update Codex config file (TOML format)
CODEX_CONFIG_FILE="$HOME/.codex/config.toml"
if [ -f "$ASSISTANTS_DIR/codex/config.toml" ] && [ -s "$ASSISTANTS_DIR/codex/config.toml" ]; then
    if [ -f "$CODEX_CONFIG_FILE" ]; then
        echo "Note: Codex config exists. Manual merge may be needed for TOML format."
        echo "Template: $ASSISTANTS_DIR/codex/config.toml"
    else
        cp "$ASSISTANTS_DIR/codex/config.toml" "$CODEX_CONFIG_FILE"
    fi
fi

# Create or update Gemini config file (JSON format)
GEMINI_CONFIG_FILE="$HOME/.gemini/settings.json"
if command -v jq >/dev/null 2>&1; then
    # Use jq for proper JSON merging
    if [ -f "$GEMINI_CONFIG_FILE" ]; then
        # Merge with existing file
        jq -s '.[0] * .[1]' "$GEMINI_CONFIG_FILE" "$ASSISTANTS_DIR/gemini/config.json" > "${GEMINI_CONFIG_FILE}.tmp" && \
        mv "${GEMINI_CONFIG_FILE}.tmp" "$GEMINI_CONFIG_FILE"
    else
        # Create new file from template
        cp "$ASSISTANTS_DIR/gemini/config.json" "$GEMINI_CONFIG_FILE"
    fi
else
    # Fallback without jq
    if [ -f "$GEMINI_CONFIG_FILE" ]; then
        echo "Warning: jq not found. Creating backup and overwriting Gemini config."
        cp "$GEMINI_CONFIG_FILE" "${GEMINI_CONFIG_FILE}.backup"
    fi
    cp "$ASSISTANTS_DIR/gemini/config.json" "$GEMINI_CONFIG_FILE"
fi

# Create or update OpenCode config file (JSON format)
OPENCODE_CONFIG_FILE="$HOME/.opencode/settings.json"
if [ -f "$ASSISTANTS_DIR/opencode/config.json" ] && [ -s "$ASSISTANTS_DIR/opencode/config.json" ]; then
    if command -v jq >/dev/null 2>&1; then
        # Use jq for proper JSON merging
        if [ -f "$OPENCODE_CONFIG_FILE" ]; then
            # Merge with existing file
            jq -s '.[0] * .[1]' "$OPENCODE_CONFIG_FILE" "$ASSISTANTS_DIR/opencode/config.json" > "${OPENCODE_CONFIG_FILE}.tmp" && \
            mv "${OPENCODE_CONFIG_FILE}.tmp" "$OPENCODE_CONFIG_FILE"
        else
            # Create new file from template
            cp "$ASSISTANTS_DIR/opencode/config.json" "$OPENCODE_CONFIG_FILE"
        fi
    else
        # Fallback without jq
        if [ -f "$OPENCODE_CONFIG_FILE" ]; then
            echo "Warning: jq not found. Creating backup and overwriting OpenCode config."
            cp "$OPENCODE_CONFIG_FILE" "${OPENCODE_CONFIG_FILE}.backup"
        fi
        cp "$ASSISTANTS_DIR/opencode/config.json" "$OPENCODE_CONFIG_FILE"
    fi
fi

echo "✓ Merged Claude config: $CLAUDE_CONFIG_FILE"
echo "✓ Updated Codex config: $CODEX_CONFIG_FILE"
echo "✓ Merged Gemini config: $GEMINI_CONFIG_FILE"
echo "✓ Updated OpenCode config: $OPENCODE_CONFIG_FILE"
echo "✓ Created/updated global CLAUDE.md: $CLAUDE_MD_PATH"
echo "✓ Created/updated global AGENTS.md: $CODEX_MD_PATH"
echo "✓ Created/updated global GEMINI.md: $GEMINI_MD_PATH"
echo "✓ Created/updated global OPENCODE.md: $OPENCODE_MD_PATH"
echo "✓ Copied commands to Claude: $CLAUDE_COMMANDS_DIR"
echo "✓ Copied prompts to Codex: $CODEX_PROMPTS_DIR"
echo "✓ Copied commands to Gemini: $GEMINI_COMMANDS_DIR"
echo "✓ Copied commands to OpenCode: $OPENCODE_COMMANDS_DIR"

echo ""
echo "Global assistant settings configured successfully!"
echo "Claude config file: $CLAUDE_CONFIG_FILE"
echo "Claude memory file: $CLAUDE_MD_PATH"
echo "Codex memory file: $CODEX_MD_PATH"
echo "Gemini memory file: $GEMINI_MD_PATH"
echo "OpenCode memory file: $OPENCODE_MD_PATH"

# Display the current settings for all assistants
echo ""
echo "Current settings:"
echo "─────────────────"

echo "Claude ($CLAUDE_CONFIG_FILE):"
if command -v jq >/dev/null 2>&1 && [ -f "$CLAUDE_CONFIG_FILE" ]; then
    jq . "$CLAUDE_CONFIG_FILE"
elif [ -f "$CLAUDE_CONFIG_FILE" ]; then
    cat "$CLAUDE_CONFIG_FILE"
else
    echo "  (not configured)"
fi

echo ""
echo "Codex ($CODEX_CONFIG_FILE):"
if [ -f "$CODEX_CONFIG_FILE" ]; then
    cat "$CODEX_CONFIG_FILE"
else
    echo "  (not configured)"
fi

echo ""
echo "Gemini ($GEMINI_CONFIG_FILE):"
if command -v jq >/dev/null 2>&1 && [ -f "$GEMINI_CONFIG_FILE" ]; then
    jq . "$GEMINI_CONFIG_FILE"
elif [ -f "$GEMINI_CONFIG_FILE" ]; then
    cat "$GEMINI_CONFIG_FILE"
else
    echo "  (not configured)"
fi

echo ""
echo "OpenCode ($OPENCODE_CONFIG_FILE):"
if command -v jq >/dev/null 2>&1 && [ -f "$OPENCODE_CONFIG_FILE" ]; then
    jq . "$OPENCODE_CONFIG_FILE"
elif [ -f "$OPENCODE_CONFIG_FILE" ]; then
    cat "$OPENCODE_CONFIG_FILE"
else
    echo "  (not configured)"
fi

echo ""
echo "⚙️  Documentation for global settings:"
echo "──────────────────────────────────────────────────"
echo "Claude:  https://docs.anthropic.com/en/docs/claude-code/settings"
echo "Codex:   https://github.com/openai/codex/blob/main/docs/config.md"
echo "Gemini:  https://github.com/google-gemini/gemini-cli/blob/main/docs/cli/configuration.md"
echo ""
echo "📚 Documentation for global memory files:"
echo "──────────────────────────────────────────────────"
echo "Claude:  https://docs.anthropic.com/en/docs/claude-code/memory#determine-memory-type"
echo "Codex:   https://github.com/openai/codex/blob/main/docs/getting-started.md#memory-with-agentsmd"
echo "Gemini:  https://github.com/google-gemini/gemini-cli/blob/main/docs/cli/configuration.md#example-context-file-content-eg-geminimd"
echo ""
echo "📝 Documentation for commands/prompts:"
echo "──────────────────────────────────────────────────"
echo "Claude:  https://docs.anthropic.com/en/docs/claude-code/common-workflows#create-personal-slash-commands"
echo "Codex:   https://github.com/openai/codex/blob/main/docs/prompts.md"
echo "Gemini:  https://github.com/google-gemini/gemini-cli/blob/main/docs/cli/commands.md#example-a-pure-function-refactoring-command"